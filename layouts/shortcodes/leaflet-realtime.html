{{if .IsNamedParams}}
<style>
    /* override these for one-two-three theme*/
    .leaflet-control a::after {
        content:none;
    }
    .leaflet-control a:hover {
        border-radius:0px;
    }
    .aeroplane-visible {
        background: #109856;
        border: none;
        opacity: 1.0;
    }
</style>

<div id='map{{.Get "id"}}' style='width:{{.Get "width"}};height:{{.Get "height"}};'></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-realtime/2.0.0/leaflet-realtime.min.js" type="text/javascript"></script>
<script>
    var center = [58.65, 25.06],
        radarbeam = {"type":"LineString", "coordinates": [[center[1], center[0]], [center[1], center[0]]]};
    var map = L.map('map{{.Get "id"}}').setView(center, 5),
        // air traffic locations layer,
        // should actually request when the "radar beam" is pointing N e.g
        // but we'll go with L.Realtime for the moment.
        realtime = L.realtime('https://tkardi.ee/current/flightradar/?format=json', {
            interval: 10 * 1000,
            getFeatureId: function(feature) {
                return feature.id;
            },
            pointToLayer: function(feature, latlng) {
                var marker = L.marker(latlng, {
                    icon: L.divIcon({
                        className:'aeroplane-visible',
                        iconSize: [10,10]
                    }),
                    riseOnHover: true
                }).bindTooltip(
                    '<b>{callsign}</b><br>Alt: {geo_altitude} m @ {velocity} m/s'.replace(
                        L.Util.templateRe, function (str, key) {
                            var value = feature.properties[key];
                            if (value === undefined || value == null) {
                                value = 'N/A';
                            } else if (typeof value === 'function') {
                                value = value(data);
                            }
                            return value;
                        }),
                    {
                        permanent: false, opacity: 0.7}
                );
                return marker;
            },
            pointInPolygon: function (latlng, latlngs) {
                // taken with slight modifications from
                // https://github.com/substack/point-in-polygon/blob/master/index.js

                var x = latlng.lng, y = latlng.lat;

                var inside = false;
                for (var i = 0, j = latlngs.length - 1; i < latlngs.length; j = i++) {
                    var xi = latlngs[i].lng, yi = latlngs[i].lat;
                    var xj = latlngs[j].lng, yj = latlngs[j].lat;

                    var intersect = ((yi > y) != (yj > y))
                        && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }

                return inside;
            },
            onEachFeature: function(feature, layer) {
                layer.on({
                    click: function (e) {
                        follow_layer_id = e.target.feature.id;
                        map.panTo(e.target.getLatLng());
                    },
                });
            }
        }).addTo(map);
    L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
        attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'
    }).addTo(map);

    map.attributionControl.addAttribution(
        '<br>Marker animation: <a href="https://github.com/perliedman/leaflet-realtime">Leaflet Realtime</a>'
    );
    map.attributionControl.addAttribution(
        '<br>Air traffic location data from <a href="http://www.opensky-network.org">The OpenSky Network</a>\'s public <a href="https://opensky-network.org/apidoc/">API</a>'
    );
</script>

{{end}}
